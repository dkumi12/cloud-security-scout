AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Cloud Security Scout - Scanner + Dashboard + API

Globals:
  Function:
    Runtime: python3.12
    Timeout: 120
    MemorySize: 256
    Environment:
      Variables:
        FINDINGS_TABLE: !Ref CloudSecurityScoutTable

Resources:

  # =============================================================================
  # DYNAMODB TABLE
  # =============================================================================
  CloudSecurityScoutTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: CloudSecurityScoutFindings
      AttributeDefinitions:
        - AttributeName: finding_id
          AttributeType: S
      KeySchema:
        - AttributeName: finding_id
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST

  # =============================================================================
  # SNS TOPIC FOR ALERTS
  # =============================================================================
  CloudSecurityScoutTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: cloud-security-scout-alerts

  # =============================================================================
  # S3 BUCKET FOR DASHBOARD
  # =============================================================================
  DashboardBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub cloud-security-scout-dashboard-${AWS::AccountId}
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false
      WebsiteConfiguration:
        IndexDocument: index.html
        ErrorDocument: error.html

  DashboardBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref DashboardBucket
      PolicyDocument:
        Statement:
          - Sid: PublicReadGetObject
            Effect: Allow
            Principal: '*'
            Action: s3:GetObject
            Resource: !Sub ${DashboardBucket.Arn}/*

  # =============================================================================
  # SCANNER LAMBDA (Existing)
  # =============================================================================
  CloudSecurityScoutRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: CloudSecurityScoutInlinePolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: DynamoDBAccess
                Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:Query
                  - dynamodb:Scan
                  - dynamodb:GetItem
                Resource: !GetAtt CloudSecurityScoutTable.Arn
              - Sid: SNSPublish
                Effect: Allow
                Action:
                  - sns:Publish
                Resource: !Ref CloudSecurityScoutTopic
              - Sid: DescribeEC2
                Effect: Allow
                Action:
                  - ec2:DescribeSecurityGroups
                  - ec2:DescribeSecurityGroupRules
                  - ec2:DescribeInstances
                Resource: "*"
              - Sid: S3Read
                Effect: Allow
                Action:
                  - s3:GetBucketAcl
                  - s3:GetBucketPolicy
                  - s3:GetPublicAccessBlock
                  - s3:ListAllMyBuckets
                Resource: "*"
              - Sid: RDSDescribe
                Effect: Allow
                Action:
                  - rds:DescribeDBInstances
                Resource: "*"
              - Sid: SecretsAccessPlaceholder
                Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                  - ssm:GetParameter
                Resource: "*"

  CloudSecurityScoutFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: cloud-security-scout
      Handler: app.lambda_handler
      CodeUri: .
      Role: !GetAtt CloudSecurityScoutRole.Arn
      Environment:
        Variables:
          ALERT_TOPIC_ARN: !Ref CloudSecurityScoutTopic
          SLACK_WEBHOOK_URL: ""
          SCAN_REGIONS: ""
      Events:
        DailySchedule:
          Type: Schedule
          Properties:
            Schedule: rate(24 hours)

  # =============================================================================
  # API GATEWAY + LAMBDA FOR DASHBOARD
  # =============================================================================
  SecurityDashboardApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: prod
      Cors:
        AllowOrigin: "'*'"
        AllowMethods: "'GET,OPTIONS'"
        AllowHeaders: "'Content-Type'"

  GetFindingsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: cloud-security-scout-api
      Handler: get_findings.lambda_handler
      CodeUri: api/
      Role: !GetAtt CloudSecurityScoutRole.Arn
      Events:
        GetFindings:
          Type: Api
          Properties:
            RestApiId: !Ref SecurityDashboardApi
            Path: /findings
            Method: get

  # =============================================================================
  # OUTPUTS
  # =============================================================================
Outputs:
  ScannerFunctionName:
    Description: "Cloud Security Scout Scanner Lambda"
    Value: !Ref CloudSecurityScoutFunction

  ApiFunctionName:
    Description: "API Lambda Function"
    Value: !Ref GetFindingsFunction

  FindingsTable:
    Description: "DynamoDB table for findings"
    Value: !Ref CloudSecurityScoutTable

  SNSTopic:
    Description: "SNS topic for alerts"
    Value: !Ref CloudSecurityScoutTopic

  DashboardBucket:
    Description: "S3 bucket for dashboard"
    Value: !Ref DashboardBucket

  DashboardURL:
    Description: "Dashboard Website URL"
    Value: !Sub "http://${DashboardBucket}.s3-website-${AWS::Region}.amazonaws.com"

  ApiEndpoint:
    Description: "API Gateway endpoint for dashboard"
    Value: !Sub "https://${SecurityDashboardApi}.execute-api.${AWS::Region}.amazonaws.com/prod/findings"
